name: Build and Notify

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_and_notify:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # 0Ô∏è‚É£ Checkout
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ---------------------------------
      # 1Ô∏è‚É£ Read commit message (FIXED)
      # ---------------------------------
      - name: Read commit message
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"

          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Extract & CLEAN link (remove newline / spaces)
          LINK=$(echo "$COMMIT_MSG" \
            | sed -n 's/^link:[[:space:]]*//p' \
            | tr -d '\r' \
            | xargs)

          NODOC=$(echo "$COMMIT_MSG" | grep -x 'nodoc' || true)

          echo "LINK=$LINK" >> $GITHUB_ENV
          echo "NODOC=$NODOC" >> $GITHUB_ENV

          echo "DEBUG: LINK=[$LINK]"

      # ---------------------------------
      # 2Ô∏è‚É£ Detect docs change (policy only)
      # ---------------------------------
      - name: Detect docs change
        id: detect_docs
        run: |
          DOCS_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^docs/' || true)

          if [ -n "$DOCS_CHANGED" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------
      # 3Ô∏è‚É£ Enforce commit message rules
      # ---------------------------------
      - name: Enforce commit message policy
        run: |
          if [ "${{ steps.detect_docs.outputs.docs_changed }}" = "true" ]; then
            if [ -z "$LINK" ]; then
              echo "‚ùå Docs changed but commit message missing 'link:'"
              exit 1
            fi
          else
            if [ -z "$NODOC" ]; then
              echo "‚ùå No docs changed but commit message missing 'nodoc'"
              exit 1
            fi
          fi

      # ---------------------------------
      # 4Ô∏è‚É£ Validate LINK FORMAT (NOT FILE)
      # ---------------------------------
      - name: Validate Docusaurus route
        if: env.LINK != ''
        run: |
          if ! echo "$LINK" | grep -q '^/'; then
            echo "‚ùå link must start with '/'"
            exit 1
          fi

          echo "‚úÖ Valid route: $LINK"

      # ---------------------------------
      # 5Ô∏è‚É£ Node.js build
      # ---------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: npm install

      - name: Build site
        run: npm run build

      # ---------------------------------
      # 6Ô∏è‚É£ Discord notification (FIXED)
      # ---------------------------------
      - name: Send Discord notification
        if: success() && env.LINK != ''
        env:
          GENERAL_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GENERAL }}
          LLVM_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}
        run: |
          ARTICLE_URL="https://www.compilersutra.com/docs${LINK}"

          echo "Sending URL: $ARTICLE_URL"

          MSG="**New article published on CompilerSutra üöÄ**\n${ARTICLE_URL}"

          send() {
            local WEBHOOK="$1"
            [ -z "$WEBHOOK" ] && return
            curl -sS -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\":\"$MSG\"}" \
              "$WEBHOOK"
          }

          if echo "$LINK" | grep -q '^/llvm'; then
            send "$LLVM_WEBHOOK"
          else
            send "$GENERAL_WEBHOOK"
          fi

