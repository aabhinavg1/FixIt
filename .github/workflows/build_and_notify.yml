name: Build and Notify

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_and_notify:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # 0 Checkout
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5

      # ---------------------------------
      # 1 Detect docs-related commits
      # ---------------------------------
      - name: Detect docs commits
        id: detect_docs
        run: |
          DOC_COMMITS="$(git log --pretty=format:%H HEAD~5..HEAD -- docs/ || true)"

          if [ -n "$DOC_COMMITS" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "DOC_COMMITS=$DOC_COMMITS" >> $GITHUB_ENV
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------
      # 2 Read and print commit messages
      # ---------------------------------
      - name: Read commit messages
        run: |
          if [ "${{ steps.detect_docs.outputs.docs_changed }}" = "true" ]; then
            echo "Docs changed. Reading commit messages that touched docs."
            MSGS="$(git log --pretty=%B HEAD~5..HEAD -- docs/)"
          else
            echo "No docs changed. Reading HEAD commit message."
            MSGS="$(git log -1 --pretty=%B)"
          fi

          echo ""
          echo "================ COMMIT MESSAGE(S) READ BY CI ================"
          echo "$MSGS"
          echo "=============================================================="
          echo ""

          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$MSGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          LINK="$(echo "$MSGS" \
            | grep -i '^[[:space:]]*link:' \
            | head -n 1 \
            | sed 's/^[[:space:]]*[Ll][Ii][Nn][Kk]:[[:space:]]*//' \
            | xargs)"

          NODOC="$(echo "$MSGS" | grep -i '^[[:space:]]*nodoc' || true)"

          echo "LINK=$LINK" >> $GITHUB_ENV
          echo "NODOC=$NODOC" >> $GITHUB_ENV

          echo "DEBUG PARSED LINK  = [$LINK]"
          echo "DEBUG PARSED NODOC = [$NODOC]"

      # ---------------------------------
      # 3 Enforce commit message policy
      # ---------------------------------
      - name: Enforce commit message policy
        run: |
          if [ "${{ steps.detect_docs.outputs.docs_changed }}" = "true" ]; then
            if [ -z "$LINK" ]; then
              echo "Docs changed but missing 'link:' in commit message."
              exit 1
            fi
          else
            if [ -z "$NODOC" ]; then
              echo "No docs changed but missing 'nodoc' in commit message."
              exit 1
            fi
          fi

      # ---------------------------------
      # 4 Validate link format
      # ---------------------------------
      - name: Validate link format
        if: env.LINK != ''
        run: |
          if ! echo "$LINK" | grep -q '^/'; then
            echo "Invalid link format. Link must start with '/'."
            exit 1
          fi
          echo "Valid route: $LINK"

      # ---------------------------------
      # 5 Build site
      # ---------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: npm install

      - name: Build site
        run: npm run build

      # ---------------------------------
      # 6 Discord notification
      # ---------------------------------
      - name: Send Discord notification
        if: success() && env.LINK != ''
        env:
          GENERAL_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GENERAL }}
          LLVM_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}
        run: |
          ARTICLE_URL="https://www.compilersutra.com/docs${LINK}"
          MSG="New article published on CompilerSutra\n${ARTICLE_URL}"

          clean() {
            echo "$1" | tr -d '\r\n' | xargs
          }

          send() {
            WEBHOOK="$(clean "$1")"
            [ -z "$WEBHOOK" ] && return
            curl -sS \
              -H "Content-Type: application/json" \
              -X POST \
              --data-binary "$(printf '{"content":"%s"}' "$MSG")" \
              "$WEBHOOK"
          }

          if echo "$LINK" | grep -q '^/llvm'; then
            send "$LLVM_WEBHOOK"
          else
            send "$GENERAL_WEBHOOK"
          fi
