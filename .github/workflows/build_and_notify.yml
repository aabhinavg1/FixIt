name: Build and Notify

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build_and_notify:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------
      # 0Ô∏è‚É£ Checkout
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ---------------------------------
      # 1Ô∏è‚É£ Read commit message (CLEAN)
      # ---------------------------------
      - name: Read commit message
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"

          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Extract + trim link (NO newline)
          LINK="$(echo "$COMMIT_MSG" \
            | sed -n 's/^link:[[:space:]]*//p' \
            | tr -d '\r\n' \
            | xargs)"

          NODOC="$(echo "$COMMIT_MSG" | grep -x 'nodoc' || true)"

          echo "LINK=$LINK" >> $GITHUB_ENV
          echo "NODOC=$NODOC" >> $GITHUB_ENV

          echo "DEBUG LINK=[$LINK]"

      # ---------------------------------
      # 2Ô∏è‚É£ Detect docs change (POLICY)
      # ---------------------------------
      - name: Detect docs change
        id: detect_docs
        run: |
          DOCS_CHANGED=$(git diff --name-only HEAD^ HEAD | grep '^docs/' || true)

          if [ -n "$DOCS_CHANGED" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------
      # 3Ô∏è‚É£ Enforce commit message rules
      # ---------------------------------
      - name: Enforce commit message policy
        run: |
          if [ "${{ steps.detect_docs.outputs.docs_changed }}" = "true" ]; then
            if [ -z "$LINK" ]; then
              echo "‚ùå Docs changed but missing 'link:'"
              exit 1
            fi
          else
            if [ -z "$NODOC" ]; then
              echo "‚ùå No docs changed but missing 'nodoc'"
              exit 1
            fi
          fi

      # ---------------------------------
      # 4Ô∏è‚É£ Validate Docusaurus route
      # ---------------------------------
      - name: Validate link format
        if: env.LINK != ''
        run: |
          if ! echo "$LINK" | grep -q '^/'; then
            echo "‚ùå link must start with '/'"
            exit 1
          fi
          echo "‚úÖ Valid route: $LINK"

      # ---------------------------------
      # 5Ô∏è‚É£ Build site
      # ---------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: npm install

      - name: Build site
        run: npm run build

      # ---------------------------------
      # 6Ô∏è‚É£ Discord notification (BULLETPROOF)
      # ---------------------------------
      - name: Send Discord notification
        if: success() && env.LINK != ''
        env:
          GENERAL_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GENERAL }}
          LLVM_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}
        run: |
          ARTICLE_URL="https://www.compilersutra.com/docs${LINK}"
          MSG="**New article published on CompilerSutra üöÄ**\n${ARTICLE_URL}"

          clean() {
            echo "$1" | tr -d '\r\n' | xargs
          }

          send() {
            RAW="$1"
            WEBHOOK="$(clean "$RAW")"
            [ -z "$WEBHOOK" ] && return

            echo "Posting to Discord..."

            curl -sS \
              -H "Content-Type: application/json" \
              -X POST \
              --data-binary "$(printf '{"content":"%s"}' "$MSG")" \
              "$WEBHOOK"
          }

          if echo "$LINK" | grep -q '^/llvm'; then
            send "$LLVM_WEBHOOK"
          else
            send "$GENERAL_WEBHOOK"
          fi
