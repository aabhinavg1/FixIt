name: Notify Discord After Deploy

on:
  workflow_run:
    workflows:
      - "Node.js CI"
    types:
      - completed

jobs:
  discord-notify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout exact commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 2

      - name: Detect changed docs
        run: |
          AFTER_SHA="${{ github.event.workflow_run.head_sha }}"
          BEFORE_SHA=$(git rev-parse "${AFTER_SHA}^")

          echo "Diffing commits:"
          echo "$BEFORE_SHA â†’ $AFTER_SHA"

          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA" | grep '^docs/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No docs changes detected"
            exit 0
          fi

          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Discord notification
        run: |
          IFS=$'\n' read -r -a FILES <<< "${CHANGED_FILES}"

          GENERAL_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_GENERAL }}"
          LLVM_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}"

          GENERAL_MSG="ðŸ†• **New articles are LIVE on CompilerSutra**\n"
          LLVM_MSG="ðŸ†• **New LLVM articles are LIVE on CompilerSutra**\n"

          GENERAL_COUNT=0
          LLVM_COUNT=0

          for FILE in "${FILES[@]}"; do
            URL_PATH="${FILE#docs/}"
            URL_PATH="${URL_PATH%.*}/"
            ARTICLE_URL="https://www.compilersutra.com/${URL_PATH}"

            TITLE=$(sed -n 's/^title:[[:space:]]*//p' "$FILE" | head -n 1)
            if [ -z "$TITLE" ]; then
              TITLE=$(basename "$FILE" .md | tr '-' ' ')
            fi

            LINE="â€¢ **${TITLE}**\n  ðŸ”— ${ARTICLE_URL}\n"

            if [[ "$FILE" == *llvm* ]]; then
              LLVM_MSG+="$LINE"
              LLVM_COUNT=$((LLVM_COUNT + 1))
            else
              GENERAL_MSG+="$LINE"
              GENERAL_COUNT=$((GENERAL_COUNT + 1))
            fi
          done

          send() {
            local MSG="$1"
            local WEBHOOK="$2"
            [ -z "$WEBHOOK" ] && return
            curl -sS -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\":\"$MSG\"}" \
              "$WEBHOOK"
          }

          if [ "$GENERAL_COUNT" -gt 0 ]; then
            send "$GENERAL_MSG" "$GENERAL_WEBHOOK"
          fi

          if [ "$LLVM_COUNT" -gt 0 ]; then
            send "$LLVM_MSG" "$LLVM_WEBHOOK"
          fi
