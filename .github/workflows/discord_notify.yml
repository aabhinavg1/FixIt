name: Discord Notify

on:
  workflow_call:
    inputs:
      docs_sha:
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed docs
        run: |
          AFTER_SHA="${{ inputs.docs_sha }}"
          BEFORE_SHA=$(git rev-parse "${AFTER_SHA}^")

          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA" | grep '^docs/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No docs changed"
            exit 0
          fi

          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Discord notifications
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GENERAL_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GENERAL }}
          LLVM_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}
        run: |
          IFS=$'\n' read -r -a FILES <<< "${CHANGED_FILES}"

          GENERAL_MSG="ðŸ†• **New articles are LIVE on CompilerSutra**\n"
          LLVM_MSG="ðŸ†• **New LLVM articles are LIVE on CompilerSutra**\n"

          for FILE in "${FILES[@]}"; do
            URL_PATH="${FILE#docs/}"
            URL_PATH="${URL_PATH%.*}/"
            ARTICLE_URL="https://www.compilersutra.com/${URL_PATH}"

            TITLE=$(sed -n 's/^title:[[:space:]]*//p' "$FILE" | head -n 1)
            [ -z "$TITLE" ] && TITLE=$(basename "$FILE" .md | tr '-' ' ')

            LINE="â€¢ **${TITLE}**\n  ðŸ”— ${ARTICLE_URL}\n"

            if [[ "$FILE" == *llvm* ]]; then
              LLVM_MSG+="$LINE"
            else
              GENERAL_MSG+="$LINE"
            fi
          done

          send() {
            local MSG="$1"
            local WEBHOOK="$2"
            [ -z "$WEBHOOK" ] && return
            curl -sS -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\":\"$MSG\"}" \
              "$WEBHOOK"
          }

          send "$GENERAL_MSG" "$GENERAL_WEBHOOK"
          send "$LLVM_MSG" "$LLVM_WEBHOOK"
