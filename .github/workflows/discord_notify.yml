name: Notify Discord After Deploy

on:
  push:
    branches: ["main"]
    paths:
      - "docs/**"   # Only trigger if docs changed

jobs:
  discord-notify:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ‚Üê allows GitHub CLI to authenticate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Wait for Node.js CI to complete
        run: |
          echo "Waiting for latest Node.js CI run to complete..."
          ATTEMPTS=0
          CI_STATUS="pending"

          while [[ "$CI_STATUS" != "success" && "$ATTEMPTS" -lt 20 ]]; do
            sleep 30
            ATTEMPTS=$((ATTEMPTS+1))
            CI_STATUS=$(gh run list --workflow "Node.js CI" --branch main --limit 1 --json conclusion,status \
                         | jq -r '.[0].conclusion')
            echo "Attempt $ATTEMPTS: Node.js CI status = $CI_STATUS"
          done

          if [[ "$CI_STATUS" != "success" ]]; then
            echo "Node.js CI did not complete successfully. Exiting."
            exit 1
          fi

      - name: Detect changed docs
        run: |
          BEFORE_SHA=$(git rev-parse HEAD~1)
          AFTER_SHA=$(git rev-parse HEAD)
          echo "Diffing commits:"
          echo "$BEFORE_SHA ‚Üí $AFTER_SHA"

          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA" | grep '^docs/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No docs changes detected"
            exit 0
          fi

          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Discord notification
        run: |
          IFS=$'\n' read -r -a FILES <<< "${CHANGED_FILES}"

          GENERAL_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_GENERAL }}"
          LLVM_WEBHOOK="${{ secrets.DISCORD_WEBHOOK_LLVM_DISCUSSION }}"

          GENERAL_MSG="üÜï **New articles are LIVE on CompilerSutra**\n"
          LLVM_MSG="üÜï **New LLVM articles are LIVE on CompilerSutra**\n"

          GENERAL_COUNT=0
          LLVM_COUNT=0

          for FILE in "${FILES[@]}"; do
            URL_PATH="${FILE#docs/}"
            URL_PATH="${URL_PATH%.*}/"
            ARTICLE_URL="https://www.compilersutra.com/${URL_PATH}"

            TITLE=$(sed -n 's/^title:[[:space:]]*//p' "$FILE" | head -n 1)
            if [ -z "$TITLE" ]; then
              TITLE=$(basename "$FILE" .md | tr '-' ' ')
            fi

            LINE="‚Ä¢ **${TITLE}**\n  üîó ${ARTICLE_URL}\n"

            if [[ "$FILE" == *llvm* ]]; then
              LLVM_MSG+="$LINE"
              LLVM_COUNT=$((LLVM_COUNT + 1))
            else
              GENERAL_MSG+="$LINE"
              GENERAL_COUNT=$((GENERAL_COUNT + 1))
            fi
          done

          send() {
            local MSG="$1"
            local WEBHOOK="$2"
            [ -z "$WEBHOOK" ] && return
            curl -sS -H "Content-Type: application/json" \
              -X POST \
              -d "{\"content\":\"$MSG\"}" \
              "$WEBHOOK"
          }

          if [ "$GENERAL_COUNT" -gt 0 ]; then
            send "$GENERAL_MSG" "$GENERAL_WEBHOOK"
          fi

          if [ "$LLVM_COUNT" -gt 0 ]; then
            send "$LLVM_MSG" "$LLVM_WEBHOOK"
          fi
